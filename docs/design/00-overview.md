# BigQuery/GA4 自律分析エージェント システム設計書

## プロジェクト概要

### 目的

MCPを経由してAIエージェントがBigQueryおよびGA4のデータを自律的・探索的に分析する仕組みを構築する。

### 要件優先順位

| 優先度 | 要件 | 説明 |
|--------|------|------|
| 1 | セキュリティ | 広告のセンシティブなデータの流出リスクを最小化 |
| 2 | 分析精度 | エージェントによる高精度な自律分析の実現 |
| 3 | コスト | API利用コストの最適化 |

### 採用技術スタック

| コンポーネント | 技術 | 理由 |
|--------------|------|------|
| オーケストレーション | agentic-flow v2.0.0-alpha | 自己学習、マルチモデルルーター、MCP統合 |
| LLM API | Claude API (Anthropic) | 学習オプトアウト可能、高精度 |
| BigQuery接続 | MCP Toolbox for Databases | Google公式、セキュア |
| GA4接続 | Google Analytics MCP Server | Google公式 |
| コスト最適化 | Multi-Model Router | タスク複雑性に応じた自動モデル選択 |

---

## システム全体像

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         分析リクエスト                                    │
│                    (Slack / API / CLI)                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    agentic-flow v2.0.0-alpha                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                   Multi-Model Router                               │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ │
│  │  │ Gemini Flash│ │Claude Haiku │ │Claude Sonnet│ │ Claude Opus │ │ │
│  │  │  (Simple)   │ │ (Moderate)  │ │  (Complex)  │ │  (Expert)   │ │ │
│  │  │    $0/1M    │ │  $0.25/1M   │ │   $3/1M     │ │   $15/1M    │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                   SONA 自己学習エンジン                             │ │
│  │  • パターン学習 (<1ms オーバーヘッド)                                │ │
│  │  • LoRA微調整 (+55% 品質向上)                                       │ │
│  │  • GNNクエリ最適化 (+12.4% リコール向上)                            │ │
│  │  • ReasoningBank (分析パターン蓄積)                                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                   分析エージェント群                                │ │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐    │ │
│  │  │ クエリ生成  │ │ データ取得  │ │ 分析実行   │ │ レポート生成│    │ │
│  │  │  Agent     │ │  Agent     │ │  Agent    │ │   Agent    │    │ │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    │                                    │
│                             MCP Protocol                                │
│         ┌──────────────────────────┼──────────────────────────┐        │
│         ▼                          ▼                          ▼        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│  │  MCP Toolbox    │    │   GA4 MCP       │    │  Data Masking   │   │
│  │  (BigQuery)     │    │   Server        │    │   MCP Server    │   │
│  └────────┬────────┘    └────────┬────────┘    └─────────────────┘   │
└───────────┼──────────────────────┼──────────────────────────────────────┘
            │                      │
            ▼                      ▼
     ┌──────────────┐       ┌──────────────┐
     │  BigQuery    │       │    GA4       │
     │  Dataset     │       │  Property    │
     └──────────────┘       └──────────────┘
```

---

## ドキュメント構成

### 設計ドキュメント

| ファイル | 内容 |
|---------|------|
| [01-architecture.md](./01-architecture.md) | 詳細アーキテクチャ設計 |
| [02-security.md](./02-security.md) | セキュリティ設計 |
| [03-cost-optimization.md](./03-cost-optimization.md) | コスト最適化設計 |
| [04-mcp-integration.md](./04-mcp-integration.md) | MCP統合設計 |
| [05-analysis-agents.md](./05-analysis-agents.md) | 分析エージェント設計 |

### 実装ドキュメント

| ファイル | 内容 |
|---------|------|
| [01-setup.md](../implementation/01-setup.md) | 環境セットアップ手順 |
| [02-bigquery-mcp.md](../implementation/02-bigquery-mcp.md) | BigQuery MCP統合実装 |
| [03-ga4-mcp.md](../implementation/03-ga4-mcp.md) | GA4 MCP統合実装 |
| [04-data-masking.md](../implementation/04-data-masking.md) | データマスキング実装 |
| [05-deployment.md](../implementation/05-deployment.md) | デプロイメント手順 |

### 設定サンプル

| ファイル | 内容 |
|---------|------|
| [agentic-flow.config.ts](../config-samples/agentic-flow.config.ts) | agentic-flow設定 |
| [mcp-servers.json](../config-samples/mcp-servers.json) | MCPサーバー設定 |
| [masking-rules.yaml](../config-samples/masking-rules.yaml) | マスキングルール |

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2026-02-01 | 初版作成 |
